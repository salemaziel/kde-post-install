!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=475)}({1:function(e,t){e.exports=require("path")},10:function(e,t){e.exports=require("http")},15:function(e,t){e.exports=require("crypto")},157:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(10),s=n(7),i=n(15);t.createServer=async function(e,t){const n=function(e){if("win32"===process.platform)return`\\\\.\\pipe\\${e}-sock`;if(process.env.XDG_RUNTIME_DIR)return r.join(process.env.XDG_RUNTIME_DIR,`${e}.sock`);return r.join(s.tmpdir(),`${e}.sock`)}(`${e}-${(await async function(e){return new Promise((t,n)=>{i.randomBytes(e,(e,r)=>{e?n(e):t(r)})})}(20)).toString("hex")}`),o=new c(n,t);return o.listen(),o};class c{constructor(e,t){this.ipcHandlePath=e,this.server=o.createServer((e,n)=>{Promise.resolve(t(e,n)).catch(e=>console.error(e&&e.message||e))}),this.server.on("error",e=>console.error(e))}listen(){this.server.listen(this.ipcHandlePath)}dispose(){this.server.close()}}t.Server=c,t.readJSON=async function(e){return new Promise((t,n)=>{const r=[];e.setEncoding("utf8"),e.on("data",e=>r.push(e)),e.on("error",e=>n(e)),e.on("end",()=>{const e=JSON.parse(r.join(""));t(e)})})},t.sendData=async function(e,t){return new Promise((n,r)=>{const s={socketPath:e,path:"/",method:"POST"},i=o.request(s,e=>n(e));i.on("error",e=>r(e)),i.write(t),i.end()})};t.Queue=class{constructor(){this.messages=[]}push(e){this.messages.push(e),this.dequeueRequest&&(this.dequeueRequest.resolve(this.messages),this.dequeueRequest=void 0,this.messages=[])}async dequeue(e){if(this.messages.length){const e=this.messages;return this.messages=[],e}return this.dequeueRequest&&this.dequeueRequest.resolve([]),new Promise((t,n)=>{this.dequeueRequest={resolve:t,reject:n},"number"==typeof e&&setTimeout(n,e)})}}},16:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e){super(e.originalError&&e.originalError.message||e.description),this.manageContainer=!1,this.actions=[],this.data={},Object.assign(this,e)}}t.ContainerError=r,t.bailOut=function(e,t){throw e.write(`[1m[31m${t}[39m[22m\n`),new Error(t)},t.toErrorText=function(e){return e.split(/\r?\n/).map(e=>`[1m[31m${e}[39m[22m`).join("\r\n")+"\r\n"}},28:function(e,t){e.exports=require("child_process")},3:function(e,t){e.exports=require("fs")},35:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(28),o=n(7),s=n(3),i=n(1),c=n(8);t.terminalEscapeSequences=/(\x9B|\x1B\[)[0-?]*[ -\/]*[@-~]/g,t.createLog=function(e,n,r){const l=Date.now(),f=[];let p=!1;function g(c){!function e(t){if(t&&f.push(t),!p&&f.length){p=!0;const t=f.join("");f.length=0,s.appendFile(r,t,n=>{n&&("ENOENT"===n.code?s.mkdir(i.dirname(r),n=>{n?(p=!1,console.error(n)):s.appendFile(r,t,t=>{p=!1,t&&console.error(t),e()})}):(p=!1,console.error(n))),p=!1,e()})}}(`[${(new Date).toISOString()}] [PID ${process.pid}] ${c.replace(t.terminalEscapeSequences,"").replace(/(\r?\n)?$/,o.EOL)}`),e(n?c.replace(/\r?\n/g,"\r\n").replace(/(\r?\n)?$/,"\r\n"):c.replace(/(\r?\n)?$/,""))}let m=c.LogLevel.Info;return{write(e){c.LogLevel.Critical>=m&&g(`[${Date.now()-l} ms] ${e}`)},start(e){const t=Date.now();return c.LogLevel.Debug>=m?g(`${d(u,`[${t-l} ms] Start`)}: ${e}`):c.LogLevel.Critical>=m&&g(`[${t-l} ms] Start: ${e}`),t},stop(e,t){if(c.LogLevel.Debug>=m){const n=Date.now();g(`${d(a,`[${n-l} ms] Stop`)} (${n-t} ms): ${e}`)}},setLogLevel(e){m=e},logFilePath:r}};const a="31",u="32";function d(e,t){return t.split("\n").map(t=>`[1m[${e}m${t}[39m[22m`).join("\n")}t.findSessions=async function(e){return(await c.findProcesses(e)).filter(e=>"VSCODE_REMOTE_CONTAINERS_SESSION"in e.env).map(e=>({...e,sessionId:e.env.VSCODE_REMOTE_CONTAINERS_SESSION}))},t.dockerExecFunction=function(e,t,n,o){return async function(s){const{env:i,cwd:a,cmd:u,args:d,output:l,silent:f}=s;n={...process.env,...n};const p=await c.findWindowsExecutable("docker",e,n),g=["exec","-i"];o&&g.push("-u",o),i&&Object.keys(i).forEach(e=>g.push("-e",`${e}=${i[e]}`)),a&&g.push("-w",a),g.push(t,u),d&&g.push(...d);const m=`Run: ${p} ${g.join(" ").replace(/\n.*/g,"")}`;let w;f||(w=l.start(m));const h=r.spawn(p,g,{cwd:e,env:n});return{stdin:h.stdin,stdout:h.stdout,stderr:h.stderr,exit:new Promise((e,t)=>{h.once("error",e=>{f||l.stop(m,w),t(e)}),h.once("exit",(t,n)=>{f||l.stop(m,w),e({code:t,signal:n})})}),async terminate(){h.kill("SIGKILL")}}}}},475:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(157),o=n(1),s=n(476),i=n(477),c=n(35),a=n(8),u=n(87),d=process.argv[2],l=process.argv[3];let f=a.LogLevel[process.argv[4]]||a.LogLevel.Info;const p=o.join(process.argv[5],"shutdownMonitor.log");const g=c.createLog((function(e){a.LogLevel.Trace>=f&&r.sendData(d,JSON.stringify({type:"trace",message:e})).catch(e=>{console.error(e)})}),!1,p);g.setLogLevel(f),g.write("Starting monitor process...");const m=Date.now();let w;async function h(e){if(g.write(`Cleaning up after ${Date.now()-m} ms...`),w)switch(w.delay&&(g.write(`Delaying for ${w.delay} ms.`),await u.delay(w.delay)),l){case"dockerCompose":await s.dockerComposeShutdown(w,g);break;case"singleContainer":await i.singleContainerShutdown(w,g);break;case"test":const{stdout:e,stderr:t}=await a.runCommandNoPty(process.cwd(),w.cmd,w.args,g,{env:w.env});g.write("Command output: "+JSON.stringify({stdout:e.toString(),stderr:t.toString()}));break;default:g.write(`Type does not exist: ${l}`)}else g.write("Not configured!");if(g.write("Done."),e)try{const e=await r.sendData(d,JSON.stringify({type:"done"})),t=await r.readJSON(e);g.write("Received reply: "+JSON.stringify(t))}catch(e){g.write("Error confirming to extension: "+(e&&(e.stack||e.message)||String(e)))}}(async()=>{let e=0;for(;;)try{const t=await r.sendData(d,JSON.stringify({type:"poll"})),n=await r.readJSON(t);g.write("Received message: "+JSON.stringify(n));for(const e of n){if("cleanup"===e.type){try{await h(!0)}catch(e){g.write("Unexpected error: "+(e&&(e.stack||e.message)||String(e)))}return}"configure"===e.type&&((w=e.options).logLevel&&(f=w.logLevel,g.setLogLevel(f)),r.sendData(d,JSON.stringify({type:"reply",sequence:e.sequence})).catch(e=>{g.write("Error confirming configuration: "+(e&&(e.stack||e.message)||String(e)))}))}e=0}catch(t){if(g.write("Error polling extension: "+(t&&(t.stack||t.message)||String(t))),t&&("ECONNREFUSED"===t.code||"ENOENT"===t.code))return void await h(!1);++e>=5&&await u.delay(1e3)}})().catch(e=>{g.write("Unexpected error: "+(e&&(e.stack||e.message)||String(e)))})},476:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(35),o=n(8),s=n(56);t.dockerComposeShutdown=async function(e,t){if(e.rebuild){const n=["rm","-f",e.containerId],{stdout:r,stderr:s}=await o.runCommandNoPty(process.cwd(),"docker",n,t,{env:e.env});t.write("Command output: "+JSON.stringify({stdout:r.toString(),stderr:s.toString()}))}else if(!e.shutdownAction||"stopCompose"===e.shutdownAction){const n=r.dockerExecFunction(e.cwd,e.containerId,e.env,e.user),i=await s.launch(n,t);if(0===(await r.findSessions(i)).filter(t=>t.sessionId!==e.sessionId).length){const n=["--project-name",e.projectName];e.composeFiles.forEach(e=>n.push("-f",e)),n.push("stop","-t","0"),e.runServices&&e.runServices.length&&n.push(...e.runServices);const{stdout:r,stderr:s}=await o.runCommandNoPty(process.cwd(),"docker-compose",n,t,{env:e.env});t.write("Command output: "+JSON.stringify({stdout:r.toString(),stderr:s.toString()}))}}}},477:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(35),o=n(56),s=n(8);t.singleContainerShutdown=async function(e,t){if(e.rebuild){const n=["rm","-f",e.containerId],{stdout:r,stderr:o}=await s.runCommandNoPty(process.cwd(),"docker",n,t,{env:e.env});t.write("Command output: "+JSON.stringify({stdout:r.toString(),stderr:o.toString()}))}else if(!e.shutdownAction||"stopContainer"===e.shutdownAction){const n=r.dockerExecFunction(e.cwd,e.containerId,e.env,e.user),i=await o.launch(n,t);if(0===(await r.findSessions(i)).filter(t=>t.sessionId!==e.sessionId).length){const n=["stop","-t","0",e.containerId],{stdout:r,stderr:o}=await s.runCommandNoPty(process.cwd(),"docker",n,t,{env:e.env});t.write("Command output: "+JSON.stringify({stdout:r.toString(),stderr:o.toString()}))}}}},56:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(63),o="â„";async function s(e,t=1){return new Promise(n=>{const s=new r.StringDecoder("utf8"),i=[],c=[];function a(r){!function r(s){const u=s.indexOf(o);-1!==u?(i.push(s.substr(0,u)),c.push(i.join("")),i.length=0,c.length===t?(n(c),e.off("data",a)):r(s.substr(u+1))):i.push(s)}(s.write(r))}e.on("data",a)})}t.launch=async function(e,t,n){const r=await e({env:n?{VSCODE_REMOTE_CONTAINERS_SESSION:n}:{},cmd:"/bin/sh",args:[],output:t}),i=function(e){let t;const n=new Promise((e,n)=>t=n),r=[],o=[],s=e=>r.push(e),i=e=>o.push(e);return e.stdout.on("data",s),e.stderr.on("data",i),e.exit.then(({code:e,signal:n})=>{t(`Shell server terminated (code: ${e}, signal: ${n})\n${Buffer.concat(r).toString()}\n${Buffer.concat(o).toString()}`)},e=>{t(`Shell server failed: ${e&&(e.stack||e.message)}`)}),{unexpectedExit:n,disposeStdioListeners:()=>{e.stdout.off("data",s),e.stderr.off("data",i),r.length=0,o.length=0}}}(r);let c;return{exec:async function(e,n){const a=c=(async()=>{try{await c}catch(e){}return async function(e,n){var i;const c=`Run in container: ${e.replace(/\n.*/g,"")}`,a=t.start(c);if(r.stdin.destroyed){t.write("Stdin closed!");const{code:e,signal:n}=await r.exit;throw{message:`Shell server terminated (code: ${e}, signal: ${n})`,code:e,signal:n}}r.stdin.write(`( ${e} ); echo -n ${o}$?${o}; echo -n ${o} >&2\n`);const u=s(r.stdout,2),d=s(r.stderr),[l,f]=await u,[p]=await d,g=parseInt(f,10)||0;!1!==(null===(i=n)||void 0===i?void 0:i.logOutput)&&(t.write(l),t.write(p),g&&t.write(`Exit code ${g}`));if(t.stop(c,a),g)throw{message:`Command in container failed: ${e}`,code:g,stdout:l,stderr:p};return{stdout:l,stderr:p}}(e,n)})();try{return await Promise.race([a,i.unexpectedExit])}finally{i.disposeStdioListeners(),c===a&&(c=void 0)}}}}},63:function(e,t){e.exports=require("string_decoder")},7:function(e,t){e.exports=require("os")},8:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(3),s=n(28),i=n(16);function c(e,t){return"linux"===process.platform?e===t:e.toLowerCase()===t.toLowerCase()}async function a(e,t,n){if("win32"!==process.platform)return e;if(r.isAbsolute(e))return e;if("."!==r.dirname(e))return r.join(t,e);let o=void 0;if(n)for(let e of Object.keys(n))if("path"===e.toLowerCase()){const t=n[e];"string"==typeof t&&(o=t.split(r.delimiter));break}if(void 0===o||0===o.length)return r.join(t,e);for(let n of o){let o;if(o=r.isAbsolute(n)?r.join(n,e):r.join(t,n,e),await u(o))return o;let s=o+".com";if(await u(s))return s;if(s=o+".exe",await u(s))return s}return r.join(t,e)}function u(e){return new Promise(t=>o.stat(e,(e,n)=>{t(!e&&n.isFile())}))}!function(e){e[e.Trace=1]="Trace",e[e.Debug=2]="Debug",e[e.Info=3]="Info",e[e.Warning=4]="Warning",e[e.Error=5]="Error",e[e.Critical=6]="Critical",e[e.Off=7]="Off"}(t.LogLevel||(t.LogLevel={})),t.equalPaths=c,t.isEqualOrParent=function(e,t){return e===t||!(!e||!t)&&(!(t.length>e.length)&&(!(e.length>t.length&&e.charAt(t.length)!==r.sep)&&c(t,e.substr(0,t.length))))},t.findProcesses=async function(e){const{stdout:t}=await e.exec("for pid in `cd /proc && ls -d [0-9]*`; do { echo $pid ; readlink -f /proc/$pid/cwd ; xargs -0 < /proc/$pid/environ ; xargs -0 < /proc/$pid/cmdline ; } ; echo ; done 2>/dev/null",{logOutput:!1});return t.split("\n\n").map(e=>e.split("\n")).filter(e=>e.length>=4).map(e=>({pid:e[0],cwd:e[1],cmd:e[3],env:e[2].split(" ").reduce((e,t)=>{const n=t.indexOf("=");return-1!==n&&(e[t.substr(0,n)]=t.substr(n+1)),e},{})}))},t.tsnode=r.join(__dirname,"..","..","node_modules",".bin","ts-node"),t.isTsnode="ts-node"===r.basename(process.argv[0])||-1!==process.argv.indexOf("ts-node/register"),t.fork=t.isTsnode?(e,n,r)=>s.spawn(t.tsnode,[e,...n||[]],r):s.fork,t.runCommandNoPty=async function(e,t,n,r,c={}){const u=`Run: ${t} ${n.join(" ").replace(/\n.*/g,"")}`;let d;c.silent||(d=r.start(u));const l={...process.env,...c.env||{}};return t=await a(t,e,l),new Promise((a,f)=>{const p=[],g=[],m=s.spawn(t,n,{cwd:e,env:l});m.stdout.on("data",e=>{p.push(e)}),m.stderr.on("data",e=>{g.push(e)}),m.on("exit",e=>{try{const o=Buffer.concat(p),s=Buffer.concat(g);c.print&&(r.write(o.toString().replace(/\r?\n/g,"\r\n")),r.write(i.toErrorText(s.toString()))),c.silent||r.stop(u,d),e?f({message:`Command failed: ${t} ${n.join(" ")}`,stdout:o,stderr:s,code:e}):a({stdout:o,stderr:s})}catch(e){f(e)}}),c.stdin instanceof Buffer?m.stdin.write(c.stdin,e=>{e?f(e):m.stdin.end()}):c.stdin instanceof o.ReadStream&&c.stdin.pipe(m.stdin)})},t.findWindowsExecutable=a,t.showProgress=async function(e,t,n){e.progress.report({message:t});try{return await n}catch(n){throw e.output.write(`[1m[31mFailed: ${t}[39m[22m\r\n`),n}},t.exec=function(e,t={}){return new Promise((n,r)=>{const o=`Run: ${e}`,i=t.output&&t.output.start(o),c=s.exec(e,t,(e,s,c)=>{(e?r:n)({error:e,stdout:s,stderr:c}),t.output&&t.output.stop(o,i)});t.stdin&&c.stdin.write(t.stdin,e=>{e&&console.error(e),c.stdin.end(e=>{e&&console.error(e)})})})}},87:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nfcall=function(e,...t){return new Promise((n,r)=>e(...t,(e,t)=>e?r(e):n(t)))},t.delay=async function(e){return new Promise(t=>setTimeout(t,e))}}}));
//# sourceMappingURL=shutdownMonitorProcess.js.map